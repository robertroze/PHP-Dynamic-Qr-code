version: "3.2"
services:
  php-dynamic-qrcode:
    image: "giandonatoinverso/php-dynamic-qr-code:latest"
    restart: "unless-stopped"
    environment:
      TYPE: "docker"
      QRCODE_GENERATOR: "internal-chillerlan.qrcode"
      BASE_URL: ${BASE_URL:?}
      DATABASE_HOST: "php-dynamic-qrcode-db"
      DATABASE_PORT: "3306"
      DATABASE_NAME: ${MYSQL_DATABASE:-qrcode}
      DATABASE_USER: ${MYSQL_USER:-qrcode}
      DATABASE_PASSWORD: ${MYSQL_PASSWORD:?}
      DATABASE_PREFIX: ""
      DATABASE_CHARSET: "utf8"
    depends_on:
      - php-dynamic-qrcode-db
    volumes:
      - php_dynamic_qrcode_saved_qrcode_data:/var/www/html/saved_qrcode
    networks:
      - php-dynamic-qrcode-network
    labels:
      # Essential: tell Traefik the internal port (80 confirmed from image docs)
      - "traefik.http.services.qr-svc.loadbalancer.server.port=80"
      
      # Public: ONLY /read.php works for everyone
      - "traefik.http.routers.qr-public.rule=Host(`${QR_DOMAIN}`) && Path(`/read.php`)"
      - "traefik.http.routers.qr-public.service=qr-svc"
      - "traefik.http.routers.qr-public.entrypoints=websecure"
      - "traefik.http.routers.qr-public.tls.certresolver=letsencrypt"
      
      # VPN-only: everything else (/, index.php, admin, etc.)
      - "traefik.http.routers.qr-admin.rule=Host(`${QR_DOMAIN}`) && !Path(`/read.php`)"
      - "traefik.http.routers.qr-admin.service=qr-svc"
      - "traefik.http.routers.qr-admin.entrypoints=websecure"
      - "traefik.http.routers.qr-admin.tls.certresolver=letsencrypt"
      - "traefik.http.routers.qr-admin.middlewares=qr-vpn@docker"
      - "traefik.http.middlewares.qr-vpn.ipallowlist.sourcerange=${WG_SUBNET}"
      
  php-dynamic-qrcode-db:
    image: "giandonatoinverso/php-dynamic-qr-code-db:latest"
    restart: "unless-stopped"
    volumes:
      - php_dynamic_qrcode_db_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:?}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-qrcode}
      MYSQL_USER: ${MYSQL_USER:-qrcode}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:?}
    networks:
      - php-dynamic-qrcode-network

volumes:
  php_dynamic_qrcode_db_data:
  php_dynamic_qrcode_config_data:
  php_dynamic_qrcode_saved_qrcode_data:

networks:
  php-dynamic-qrcode-network:
    driver: bridge
